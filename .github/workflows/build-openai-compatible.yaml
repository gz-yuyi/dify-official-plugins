name: Build OpenAI Compatible Plugin

on:
  workflow_dispatch:
    inputs:
      upload_to_marketplace:
        description: 'Upload to marketplace (uncheck for test build only)'
        required: false
        type: boolean
        default: false

env:
  PLUGIN_PATH: models/openai_api_compatible
  REPO_NAME: langgenius/dify-official-plugins
  MARKETPLACE_BASE_URL: https://marketplace.dify.ai
  GH_TOKEN: ${{ github.token }}

jobs:
  build-openai-compatible-plugin:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clone Marketplace Toolkit
        run: |
          gh repo clone langgenius/dify-marketplace-toolkit -- .scripts/

      - name: Download Plugin Daemon
        run: |
          gh release download -R langgenius/dify-plugin-daemon --pattern "dify-plugin-linux-amd64" --dir .scripts || gh release download -R langgenius/dify-plugin-daemon --pattern "dify-plugin-linux-amd64" --dir .scripts
          chmod +x .scripts/dify-plugin-linux-amd64
          mv .scripts/dify-plugin-linux-amd64 /usr/local/bin/dify

      - name: Setup uv
        uses: astral-sh/setup-uv@v6
        with:
          version: "latest"
          activate-environment: false

      - name: Setup Global Python
        run: |
          uv venv --python 3.12.7
          uv pip install requests dify_plugin pytest

      - name: yq - portable yaml processor
        uses: mikefarah/yq@v4.44.5

      - name: Display Plugin Info
        run: |
          echo "### ðŸ”§ Plugin Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          AUTHOR=$(yq '.author' ${{ env.PLUGIN_PATH }}/manifest.yaml)
          NAME=$(yq '.name' ${{ env.PLUGIN_PATH }}/manifest.yaml)
          VERSION=$(yq '.version' ${{ env.PLUGIN_PATH }}/manifest.yaml)
          DESCRIPTION=$(yq '.description.en_US' ${{ env.PLUGIN_PATH }}/manifest.yaml)

          echo "**Plugin:** \`$AUTHOR/$NAME\`" | tee -a $GITHUB_STEP_SUMMARY
          echo "**Version:** \`$VERSION\`" | tee -a $GITHUB_STEP_SUMMARY
          echo "**Description:** $DESCRIPTION" | tee -a $GITHUB_STEP_SUMMARY
          echo "**Upload Mode:** \`${{ inputs.upload_to_marketplace }}\`" | tee -a $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Check Plugin Manifest
        run: |
          # manifest.yaml author must be langgenius
          if ! yq '.author' ${{ env.PLUGIN_PATH }}/manifest.yaml | grep -q "langgenius"; then
            echo "!!! Plugin manifest.yaml author must be langgenius"
            exit 1
          fi

      - name: Check for Disallowed Virtualenv Directories
        run: |
          if find "${{ env.PLUGIN_PATH }}" -maxdepth 1 -type d \( -name ".venv*" -o -name "venv*" \) | grep -q .; then
            echo "!!! Please remove .venv or venv* directory in plugin path before building"
            exit 1
          fi

      - name: Check If Version Exists in Marketplace
        if: ${{ inputs.upload_to_marketplace }}
        run: |
          VERSION=$(yq '.version' ${{ env.PLUGIN_PATH }}/manifest.yaml)
          AUTHOR=$(yq '.author' ${{ env.PLUGIN_PATH }}/manifest.yaml)
          NAME=$(yq '.name' ${{ env.PLUGIN_PATH }}/manifest.yaml)

          echo "Checking if version $VERSION exists in marketplace..."

          RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ env.MARKETPLACE_BASE_URL }}/api/v1/plugins/$AUTHOR/$NAME/$VERSION")

          if [ "$RESPONSE_CODE" = "200" ]; then
            RESPONSE=$(curl -s "${{ env.MARKETPLACE_BASE_URL }}/api/v1/plugins/$AUTHOR/$NAME/$VERSION")
            if [ "$(echo "$RESPONSE" | jq -r '.code')" = "0" ]; then
              echo "!!! Plugin version $VERSION already exists in marketplace"
              echo "Please update the version number in ${{ env.PLUGIN_PATH }}/manifest.yaml"
              exit 1
            fi
          else
            echo "âœ… Version $VERSION is available"
          fi

      - name: Run Tests
        run: |
          if [ -d "tests/${{ env.PLUGIN_PATH }}" ]; then
            echo "### ðŸ§ª Running Tests" >> $GITHUB_STEP_SUMMARY
            if [ -f "tests/${{ env.PLUGIN_PATH }}/requirements.txt" ]; then
              echo "Installing test dependencies..." | tee -a $GITHUB_STEP_SUMMARY
              uv pip install -r tests/${{ env.PLUGIN_PATH }}/requirements.txt
            fi
            echo "Running pytest..." | tee -a $GITHUB_STEP_SUMMARY
            PYTHONPATH=. uv run pytest tests/${{ env.PLUGIN_PATH }} -v || {
              echo "âŒ Tests failed" >> $GITHUB_STEP_SUMMARY
              exit 1
            }
            echo "âœ… All tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No tests found, skipping" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validate Plugin Installation
        run: |
          echo "### ðŸ“¦ Validating Plugin Installation" >> $GITHUB_STEP_SUMMARY
          cd ${{ env.PLUGIN_PATH }}
          if [ -f requirements.txt ]; then
              echo "Installing plugin dependencies..." | tee -a $GITHUB_STEP_SUMMARY
              uv pip install -r requirements.txt
              export INSTALL_METHOD=serverless
              export SERVERLESS_PORT=8080
              export SERVERLESS_HOST=0.0.0.0
          fi
          cd -
          uv run python .scripts/validator/test-plugin-install.py -d ${{ env.PLUGIN_PATH }}
          echo "âœ… Plugin installation validated" >> $GITHUB_STEP_SUMMARY

      - name: Clean Build Artifacts
        run: |
          cd ${{ env.PLUGIN_PATH }}
          rm -rf .venv

      - name: Package Plugin
        run: |
          echo "### ðŸ“¦ Building Plugin Package" >> $GITHUB_STEP_SUMMARY

          AUTHOR=$(yq '.author' ${{ env.PLUGIN_PATH }}/manifest.yaml)
          NAME=$(yq '.name' ${{ env.PLUGIN_PATH }}/manifest.yaml)
          VERSION=$(yq '.version' ${{ env.PLUGIN_PATH }}/manifest.yaml)

          # Create output directory for packages
          mkdir -p ./packages

          # Package the plugin using dify CLI
          /usr/local/bin/dify plugin package ${{ env.PLUGIN_PATH }} -o ./packages/

          # Find the generated package file
          PACKAGE_FILE=$(find ./packages -name "*.difypkg" -type f | head -n 1)

          if [ -z "$PACKAGE_FILE" ]; then
            echo "âŒ Package file not found" | tee -a $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Rename package file with a clear name
          PACKAGE_NAME="${AUTHOR}_${NAME}_${VERSION}.difypkg"
          mv "$PACKAGE_FILE" "./packages/$PACKAGE_NAME"

          echo "**Package:** \`$PACKAGE_NAME\`" | tee -a $GITHUB_STEP_SUMMARY
          echo "**Size:** \`$(du -h ./packages/$PACKAGE_NAME | cut -f1)\`" | tee -a $GITHUB_STEP_SUMMARY
          echo "âœ… Package built successfully" >> $GITHUB_STEP_SUMMARY

          # Save package name for later steps
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_ENV

      - name: Upload Plugin Package as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}
          path: ./packages/${{ env.PACKAGE_NAME }}
          retention-days: 30
          if-no-files-found: error

      - name: Upload to Marketplace
        if: ${{ inputs.upload_to_marketplace }}
        run: |
          echo "### ðŸš€ Uploading to Marketplace" >> $GITHUB_STEP_SUMMARY
          VERSION=$(yq '.version' ${{ env.PLUGIN_PATH }}/manifest.yaml)
          echo "Uploading version $VERSION to marketplace..." | tee -a $GITHUB_STEP_SUMMARY

          uv run python .scripts/uploader/upload-package.py \
            -d ${{ env.PLUGIN_PATH }} \
            -t ${{ secrets.MARKETPLACE_TOKEN }} \
            --plugin-daemon-path /usr/local/bin/dify \
            -u ${{ secrets.MARKETPLACE_BASE_URL }} \
            -f

          echo "âœ… Plugin uploaded successfully" >> $GITHUB_STEP_SUMMARY

      - name: Build Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ inputs.upload_to_marketplace }}" = "true" ]; then
            echo "âœ… Plugin has been uploaded to the marketplace" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ Test build completed (not uploaded to marketplace)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¥ Download Plugin Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The plugin package has been uploaded as an artifact." >> $GITHUB_STEP_SUMMARY
          echo "Click on the **Artifacts** section at the bottom of this page to download the \`.difypkg\` file." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Package will be available for 30 days.**" >> $GITHUB_STEP_SUMMARY
